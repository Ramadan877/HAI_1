<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chat with AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1e293b;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            height: 100%;
            width: 100%;
            position: relative;
            transition: all 0.3s ease;
        }

        .container.chat-open {
            align-items: flex-start;
            padding-left: 0%;
            width: 65%;
            transform: translateX(-10%);
        }

        @media (max-width: 1200px) {
            .container.chat-open {
                transform: translateX(-5%); /* Less shift on smaller screens */
            }
            
            .modal-content {
                margin-bottom: 180px; /* More margin to avoid avatar */
            }
        }


        #pdf-container {
             width: 100%;
             height: 100vh;
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 20px 0;
             box-sizing: border-box;
             z-index: 0; 
             transition: all 0.3s ease; 
         }

         #pdf-container.chat-open {
            width: 100%;
            max-width: 65vw;
            justify-content: flex-start;
            margin-left: 5%;
        }
 
        #pdf-canvas {
            width: 75vw;
            height: calc(100vh - 40px);
             max-height: 100%;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }
 
        .page-controls {
             position: fixed; 
             bottom: 20px; 
             display: flex;
             justify-content: center;
             gap: 20px;
             z-index: 100;
             width: 100%; 
             left: 0;
         }
 
        .page-btn {
             background-color: rgba(0, 0, 0, 0.7);
             color: white;
             border: none;
             border-radius: 50%;
             width: 40px;
             height: 40px;
             display: flex;
             justify-content: center;
             align-items: center;
             cursor: pointer;
             transition: background-color 0.3s;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }
 
        .page-btn:hover {
             background-color: rgba(0, 0, 0, 0.9);
         }
 
         .page-counter {
             background-color: rgba(0, 0, 0, 0.7);
             padding: 10px 15px;
             border-radius: 20px;
             display: flex;
             align-items: center;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }

        .avatar-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 150px;
            height: 150px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .avatar-container:hover {
            transform: scale(1.1);
        }
        
        /* Siri Sphere Animation Styles */
        .siri-orb {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.1) 60%, rgba(255,255,255,0) 70%);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.7;
            mix-blend-mode: screen;
            transform-origin: center;
            transition: all 0.5s ease;
        }
        
        .blob1 {
            width: 75px;
            height: 75px;
            background-color: #00e5ff;
            left: calc(50% - 37.5px);
            top: calc(50% - 50px);
        }
        
        .blob2 {
            width: 80px;
            height: 80px;
            background-color: #ff3366;
            left: calc(50% - 40px);
            top: calc(50% - 20px);
        }
        
        .blob3 {
            width: 70px;
            height: 70px;
            background-color: #7c4dff;
            left: calc(50% - 20px);
            top: calc(50% - 35px);
        }
        
        .wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: transparent;
            border: 2px solid rgba(0, 0, 0, 0.5);
            transform: scale(0);
            opacity: 1;
            pointer-events: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0; 
            width: 35%; 
            height: 98%;
            background-color: transparent;
            justify-content: flex-start;
            align-items: flex-end;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: #1e293b;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-height: 60vh;
            height: auto;
            margin-right: 20px;
            margin-top: 20px;
            margin-bottom: 170px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slide-in 0.3s ease-out;
            z-index: 999;
            transition: opacity 0.1s ease;
        }

        @keyframes slide-in {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Remove the triangle pointer since we're using a sidebar layout */
        .modal-content::after {
            display: none;
        }


        .modal-content:hover, 
        .modal-content.active { 
            opacity: 1;
        }

        .modal-content:not(.active) {
            opacity: 0.1;
        }

        @media (max-width: 768px) {
            .modal-content {
                right: 180px;
                bottom: 80px;
                width: 80%;
            }
        }

        @media (max-width: 576px) {
            .modal-content {
                right: 160px;
                bottom: 60px;
                width: 70%;
            }
        }

        @keyframes pop-up {
            0% {
                transform: scale(0.5) translateY(100px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .modal.show::before {
            opacity: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            height: 20px;
        }

        .modal-header h2 {
            font-family: 'Roboto', sans-serif;
            color: #4fd1c5;
            font-size: 18px;
            font-weight: 600; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            text-align: center;
            padding: 12px 0;
            margin: 0;
            border-bottom: 3px solid #ffffff; 
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #fff;
            background-color: #888;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .close-btn:hover {
            background-color: #e74c3c; 
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            transform: scale(1.2);
        }

        .close-btn:active {
            background-color: #c0392b; 
            box-shadow: none;
            transform: scale(1);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            background: transparent;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
            max-height: calc(80vh - 150px);            
        }

        @media (max-width: 768px) {
            .modal {
                width: 40%;
            }
            
            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .modal {
                width: 60%;
            }
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 90%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            position: relative;
            word-wrap: break-word;
            width: fit-content;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .user-message {
            background-color: #4fd1c5;
            color: #1e293b;
            align-self: flex-end;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 5px;
            border: 2px solid #7c4dff;
        }

        .ai-message {
            background-color: #4fd1c5;
            color: #1e293b;
            align-self: flex-start;
            border-top-left-radius: 18px;
            border-bottom-left-radius: 5px;
            border: 2px solid #ff3366;
        }
        
        
        .transcript-text {
            margin-top: 8px;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            width: 100%; 
            box-sizing: border-box;
        }

        .user-message .transcript-text {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .ai-message .transcript-text {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .audio-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box; 
            max-width: 100%;
        }

        .play-button {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            background-color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-button:hover {
            background-color: #38b2ac;
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .waveform {
            width: 100%;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .waveform-container {
            flex-grow: 1;
            height: 40px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin: 0 8px;
            min-width: 150px;
        }
                
        .waveform-visualization {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .wave-bar {
            flex: 1;
            background-color: #1e293b;
            margin: 0 1px;
            border-radius: 1px;
        }

        .progress-indicator {
            position: absolute;
            top: 50%;
            left: 0;
            height: 12px;
            width: 12px;
            background-color: #4fd1c5;
            border-radius: 50%;
            z-index: 3;
            transform: translateY(-50%);
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            transition: left 0.1s linear;
        }

        .progress-container {
            flex-grow: 1;
            position: relative;
            min-width: 150px;
        }

        .progress-bar {
            height: 4px;
            background: #d1d1d1;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            overflow: visible;
        }

        .progress {
            height: 100%;
            background: #4fd1c5;
            border-radius: 2px;
            width: 0%;
            position: relative;
        }

        .progress-thumb {
            width: 12px;
            height: 12px;
            background-color: #4fd1c5;
            border-radius: 50%;
            position: absolute;
            right: -6px;
            top: -4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .duration-display {
            font-size: 12px;
            color: #000000;
            min-width: 40px;
            text-align: center;
        }

        .speed-toggle {
            padding: 4px 8px;
            border-radius: 12px;
            border: none;
            background: #e0e0e0;
            font-size: 12px;
            font-weight: bold;
            color: #444;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-toggle:hover {
            background: #d0d0d0;
        }

        .speed-toggle:active {
            transform: scale(0.95);
        }

        .audio-player {
            display: none; 
        }

        .user-message .progress-bar {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-message .progress {
            background: rgba(255, 255, 255, 0.9);
        }

        .user-message .progress-thumb {
            background: white;
        }

        .user-message .play-button,
        .user-message .speed-toggle {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1e293b;
        }

        .user-message .duration-display {
            color: rgba(255, 255, 255, 0.9);
        }

        .options-menu {
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: opacity 0.3s;
        }

        .options-menu:hover {
            opacity: 0.7;
        }

        .options-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .options-dropdown.show {
            display: block;
        }

        .options-dropdown button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .options-dropdown button:hover {
            background: #f0f0f0;
        }

        .audio-player {
            width: 100%;
            margin-top: 8px;
        }

        .input-bar {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: #2d3748;
            border-radius: 24px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        #voice-visualizer {
            display: none;
            flex-grow: 1;
            max-width: 70%;
            height: 40px;
            background-color: transparent;
            border-radius: 8px;
            margin-right: 8px;
        }

        .action-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: #4fd1c5;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-left: auto;
            position: relative; 
            z-index: 5; 
        }

        .action-btn:hover {
            background-color: #38b2ac;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .loading-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-orbit {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .orbit-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #4fd1c5;
            animation: orbit-spin 1s linear infinite;
        }

        .orbit-circle:nth-child(2) {
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
            border-top-color: #7c4dff;
            animation: orbit-spin 0.8s linear infinite reverse;
        }

        .orbit-circle:nth-child(3) {
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            border-top-color: #ff3366;
            animation: orbit-spin 0.6s linear infinite;
        }

        @keyframes orbit-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head> 
<body>
    <div class="container">
        <div id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <div id="loading-spinner" class="loading-spinner"></div>
        </div>

        <div class="page-controls">
            <button class="page-btn" id="prev-page"><i class="fas fa-chevron-left"></i></button>
            <div class="page-counter">
                <span id="current-page-num">1</span> / <span id="total-pages">-</span>
            </div>
            <button class="page-btn" id="next-page"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="avatar-container" id="chat-avatar">
        <div class="siri-orb">
            <div class="blob blob1"></div>
            <div class="blob blob2"></div>
            <div class="blob blob3"></div>
        </div>
    </div>

    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2></h2>
                    <span class="close-btn" id="close-modal">&times;</span>
            </div>

            <div class="chat-container" id="chat-container"></div>

            <div class="input-bar">
                <canvas id="voice-visualizer"></canvas>
                <button class="action-btn" id="record-btn">
                    <i class="fas fa-microphone"></i>                    </button>
            </div>
            
            <div class="loading-indicator" id="loading-indicator">
                <div class="loading-orbit">
                    <div class="orbit-circle"></div>
                    <div class="orbit-circle"></div>
                    <div class="orbit-circle"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const url = '/resources/Univariate Analysis.pdf';
            const avatar = document.getElementById('chat-avatar');
            const modal = document.getElementById('chat-modal');
            const closeModal = document.getElementById('close-modal');
            const recordBtn = document.getElementById('record-btn');
            const chatContainer = document.getElementById('chat-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const visualizer = document.getElementById('voice-visualizer');
            const siriOrb = document.querySelector('.siri-orb');
            const blobs = document.querySelectorAll('.blob');
            const userMessages = document.querySelectorAll('.user-message');
            const lastUserMessage = userMessages[userMessages.length - 1];
            if (lastUserMessage) {
                const transcriptDiv = lastUserMessage.querySelector('.transcript-text');
                if (transcriptDiv) {
                    transcriptDiv.textContent = data.user_transcript;
                }
            }

            let isRecording = false;
            let mediaRecorder;
            let audioChunks = [];
            let isAnimating = false;
            let waves = [];
            let waveCount = 0;
            let currentConcept = "Default";
            let introPlayed = false; 
            let pdfDoc = null,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1.5,
            visualizerCanvas = document.getElementById('pdf-canvas'),
            visualizerCtx = visualizerCanvas.getContext('2d');

            function renderPage(num) {
                pageRendering = true;

                pdfDoc.getPage(num).then(function(page) {
                    const pdfContainer = document.getElementById('pdf-container');
                    const containerWidth = pdfContainer.clientWidth;
                    const containerHeight = pdfContainer.clientHeight;
                    
                    const viewport = page.getViewport({ scale: 1.0 });
                    const scaleWidth = containerWidth / viewport.width * 0.85; // Slightly smaller to avoid edges
                    const scaleHeight = containerHeight / viewport.height * 0.85;
                    const optimalScale = Math.min(scaleWidth, scaleHeight);
                    
                    const scaledViewport = page.getViewport({ scale: optimalScale });
                    
                    canvas.height = scaledViewport.height;
                    canvas.width = scaledViewport.width;

                    const scaleFactor = window.devicePixelRatio || 1;
                    visualizerCanvas.width = scaledViewport.width * scaleFactor;
                    visualizerCanvas.height = scaledViewport.height * scaleFactor;

                    visualizerCtx.setTransform(scaleFactor, 0, 0, scaleFactor, 0, 0);

                    const renderContext = {
                        canvasContext: visualizerCtx,
                        viewport: scaledViewport
                    };
                    
                    const renderTask = page.render(renderContext);

                    renderTask.promise.then(function() {
                        pageRendering = false;

                        if (pageNumPending !== null) {
                            renderPage(pageNumPending);
                            pageNumPending = null;
                        }
                    });

                    updateModalTitle(num);
                    
                    // Notify backend about concept change when page changes
                    const newConcept = getConceptNameForSlide(num);
                    if (currentConcept !== newConcept) {
                        currentConcept = newConcept;
                        notifyConceptChange(currentConcept);
                    }
                });

                document.getElementById('current-page-num').textContent = num;
            }

            window.addEventListener('resize', () => {
                if (pdfDoc) {
                    queueRenderPage(pageNum);
                }
            });

            function updateModalTitle(pageNumber) {
                const chatModalHeader = document.querySelector('.modal-header h2');
                const concept = getConceptNameForSlide(pageNumber) || "Have Fun!!"; 
                chatModalHeader.textContent = concept;
            }

            function queueRenderPage(num) {
                if (pageRendering) {
                    pageNumPending = num;
                } else {
                    renderPage(num);
                }
            }

            function onPrevPage() {
                if (pageNum <= 1) return;
                pageNum--;
                queueRenderPage(pageNum);
            }

            function onNextPage() {
                if (pageNum >= pdfDoc.numPages) return;
                pageNum++;
                queueRenderPage(pageNum);
            }

            // Add this function to notify backend of concept changes
            function notifyConceptChange(conceptName) {
                fetch('/change_concept', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        concept_name: conceptName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Concept change notification sent:', data);
                })
                .catch(error => {
                    console.error('Error notifying concept change:', error);
                });
            }
            
            // Add this function to handle "move to next concept" notification
            function notifyUserToMoveToNextConcept() {
                const notification = document.createElement('div');
                notification.className = 'next-concept-notification';
                notification.innerHTML = `
                    <p>You've completed this concept. Please move to the next concept.</p>
                    <button id="next-concept-btn">Go to Next Concept</button>
                `;
                
                document.body.appendChild(notification);
                
                document.getElementById('next-concept-btn').addEventListener('click', function() {
                    onNextPage(); // Use the existing next page function
                    notification.remove();
                });
            }

            // Update this function to be more comprehensive
            function getConceptNameForSlide(slideNumber) {
                const conceptMap = {
                    1: "Univariate Analysis",
                    2: "Univariate Analysis",
                    3: "Measures of Central Tendency",
                    4: "Measures of Dispersion"
                    // Add any additional concepts/slides here
                };
                
                return conceptMap[slideNumber] || "Unknown Concept";
            }

            document.getElementById('prev-page').addEventListener('click', onPrevPage);
            document.getElementById('next-page').addEventListener('click', onNextPage);

            // Add event listeners to all navigation buttons
            document.querySelectorAll('.slide-nav-button').forEach(button => {
                button.addEventListener('click', function() {
                    const targetSlide = this.getAttribute('data-target-slide');
                    if (targetSlide) {
                        const slideNum = parseInt(targetSlide, 10);
                        if (!isNaN(slideNum)) {
                            pageNum = slideNum;
                            queueRenderPage(pageNum);
                            
                            // Notify concept change
                            const conceptName = getConceptNameForSlide(slideNum);
                            notifyConceptChange(conceptName);
                        }
                    }
                });
            });

            pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
                pdfDoc = pdfDoc_;
                document.getElementById('total-pages').textContent = pdfDoc.numPages;
                renderPage(pageNum);
            }).catch(err => {
                console.error('Error loading PDF:', err);
                alert('Failed to load PDF: ' + err.message);
            });

            const canvas = document.getElementById('voice-visualizer');
            canvas.width = 500;
            canvas.height = 40;
            const canvasCtx = canvas.getContext('2d');
            let audioContext, analyser, dataArray, animationId;

            const introAudioUrl = '/uploads/ai_audio/intro_message.mp3';

            // Siri Animation Functions
            function animateBlobs() {
                blobs.forEach((blob, index) => {
                    const speed = 2 + index * 0.5;
                    const time = performance.now() / 1000;
                    const x = Math.sin(time * speed) * 10;
                    const y = Math.cos(time * (speed + 0.5)) * 10;
                    
                    blob.style.transform = `translate(${x}px, ${y}px) scale(${0.8 + Math.sin(time * speed) * 0.1})`;
                });
                
                requestAnimationFrame(animateBlobs);
            }
            
            function createWave() {
                const wave = document.createElement('div');
                wave.className = 'wave';
                wave.id = `wave-${waveCount++}`;
                avatar.appendChild(wave);
                waves.push(wave);
                
                setTimeout(() => {
                    wave.style.transition = 'all 2s cubic-bezier(0.1, 0.8, 0.1, 1)';
                    wave.style.transform = 'scale(1.5)';
                    wave.style.opacity = '0';
                }, 10);
                
                setTimeout(() => {
                    avatar.removeChild(wave);
                    waves = waves.filter(w => w !== wave);
                }, 2000);
            }
            
            function activateSiriOrb() {
                if (isAnimating) return;
                isAnimating = true;
                
                createWave();
                setTimeout(createWave, 200);
                setTimeout(createWave, 400);
                
                siriOrb.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    siriOrb.style.transform = 'scale(1)';
                }, 300);
                
                blobs.forEach((blob, index) => {
                    const delay = index * 100;
                    setTimeout(() => {
                        blob.style.transform = 'scale(1.2) translate(0, 0)';
                        setTimeout(() => {
                            blob.style.transform = 'scale(1) translate(0, 0)';
                        }, 400);
                    }, delay);
                });
                
                setTimeout(() => {
                    isAnimating = false;
                }, 800);
            }
            
            animateBlobs();

            function getCurrentConcept() {
                // Use the concept for the current page/slide
                return getConceptNameForSlide(pageNum);
            }

            const modalContent = document.querySelector('.modal-content');

            function showModal() {
                modal.style.display = 'flex';
                document.body.classList.add('modal-open');
                
                document.querySelector('.container').classList.add('chat-open');
                document.getElementById('pdf-container').classList.add('chat-open');
                
                if (pdfDoc) {
                    setTimeout(() => {
                        queueRenderPage(pageNum);
                    }, 300);
                }

                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
                
                if (!introPlayed) {
                    displayAudioMessage(introAudioUrl, 'ai', "Welcome! I'm your AI assistant for this Univariate Analysis session. Ask me anything about the content you're viewing.");
                    introPlayed = true; 
                }
                
                activateSiriOrb();
                
                currentConcept = getCurrentConcept();
                console.log("Current concept set to:", currentConcept);
                
                // Notify backend when modal is opened
                notifyConceptChange(currentConcept);
                
                modalContent.classList.add('active');
            }

            function hideModal() {
                modal.classList.remove('show');
                
                document.querySelector('.container').classList.remove('chat-open');
                document.getElementById('pdf-container').classList.remove('chat-open');
                
                if (pdfDoc) {
                    setTimeout(() => {
                        queueRenderPage(pageNum);
                    }, 300);
                }

                setTimeout(() => {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }, 300); 
                
                stopAllAudio();
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }

            avatar.addEventListener('click', () => {
                if (modal.classList.contains('show')) {
                    hideModal();
                } else {
                    showModal();
                }
            });


            closeModal.addEventListener('click', hideModal);

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    hideModal();
                }
            });

            recordBtn.addEventListener('click', async () => {
                if (!isRecording) {
                    try {
                        audioChunks = [];
                        isRecording = true;
                        recordBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                        activateSiriOrb();
                        siriOrb.style.boxShadow = "0 0 20px 5px rgba(255, 255, 255, 0.7)";
                        
                        visualizer.style.display = 'block';
                        recordBtn.style.display = 'flex';

                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        audioContext = new AudioContext();
                        analyser = audioContext.createAnalyser();
                        const source = audioContext.createMediaStreamSource(stream);

                        source.connect(analyser);
                        analyser.fftSize = 256;
                        dataArray = new Uint8Array(analyser.frequencyBinCount);

                        mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm'});
                        
                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };
                        
                        mediaRecorder.onerror = (event) => {
                            console.error('MediaRecorder error:', event);
                            alert('Error recording audio: ' + event.error);
                            resetRecordingState();
                        };
                        
                        mediaRecorder.start();
                        console.log("MediaRecorder started", mediaRecorder.state);

                        visualize();
                    } catch (error) {
                        console.error('Error accessing microphone:', error);
                        alert('Unable to access microphone. Please check permissions.');
                        resetRecordingState();
                    }
                } else {
                    recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';

                    stopRecording();
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                    
                    recordBtn.style.display = 'flex';
                    visualizer.style.display = 'none';
                    canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                    siriOrb.style.boxShadow = "none";
                    
                }
            });

            function visualize() {
                const WIDTH = canvas.width;
                const HEIGHT = canvas.height;
                const BAR_WIDTH = 3;
                const GAP = 2;
                const NUM_BARS = Math.floor(WIDTH / (BAR_WIDTH + GAP));

                function draw() {
                    animationId = requestAnimationFrame(draw);

                    analyser.getByteFrequencyData(dataArray);

                    canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

                    for (let i = 0; i < NUM_BARS; i++) {
                        const value = dataArray[i % dataArray.length] || 0;
                        const barHeight = (value / 255) * HEIGHT;
                        
                        const x = i * (BAR_WIDTH + GAP);
                        const y = HEIGHT - barHeight;

                        const hue = 180 - (value / 255) * 60;
                        const color = `hsl(${hue}, 80%, 60%)`;

                        canvasCtx.fillStyle = color;
                        canvasCtx.fillRect(x, y, BAR_WIDTH, barHeight);
                    }
                }

                draw();
            }

            function stopRecording() {
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    console.warn('MediaRecorder not active');
                    return;
                }
                
                console.log("Stopping MediaRecorder", mediaRecorder.state);
                isRecording = false;
                
                try {
                    mediaRecorder.stop();
                } catch (err) {
                    console.error('Error stopping MediaRecorder:', err);
                    resetRecordingState();
                    return;
                }

                mediaRecorder.onstop = async () => {
                    try {
                        loadingIndicator.classList.add('active');
                        
                        if (audioChunks.length === 0) {
                            throw new Error('No audio data recorded');
                        }
                        
                        // Always get the current concept when submitting a message
                        currentConcept = getCurrentConcept();
                        console.log("Sending audio for concept:", currentConcept);
                        
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        // Updated to use submitMessage function
                        await submitMessage(null, audioBlob);
                        
                    } catch (error) {
                        console.error('Error processing audio:', error);
                        alert('Error processing audio: ' + error.message);
                        recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    } finally {
                        loadingIndicator.classList.remove('active');
                    }
                };
            }

            // New function to submit messages (from audio or text)
            async function submitMessage(message = null, audioBlob = null) {
                try {
                    const formData = new FormData();
                    
                    // Get the current concept from the active slide
                    const currentConcept = getCurrentConcept();
                    
                    if (message) {
                        formData.append('message', message);
                    }
                    
                    if (audioBlob) {
                        formData.append('audio', audioBlob, 'user_audio.wav');
                        const userAudioUrl = URL.createObjectURL(audioBlob);
                        displayAudioMessage(userAudioUrl, 'user', 'Your message is being processed...');
                    }
                    
                    // Always include the current concept
                    formData.append('concept_name', currentConcept);
                    
                    console.log("Sending data to server with concept:", currentConcept);
                    
                    // Submit to the backend
                    const response = await fetch('/submit_message', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Server response:", data);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Update user message transcript if available
                    const userMessages = document.querySelectorAll('.user-message');
                    const lastUserMessage = userMessages[userMessages.length - 1];
                    if (lastUserMessage) {
                        const transcriptDiv = lastUserMessage.querySelector('.transcript-text');
                        if (transcriptDiv) {
                            transcriptDiv.textContent = data.user_transcript || message;
                        }
                    }

                    // Display AI response
                    displayAudioMessage(data.ai_audio_url, 'ai', data.response || data.ai_transcript);
                    activateSiriOrb();
                    
                    // Check if the user should move to the next concept
                    if (data.should_move_to_next) {
                        notifyUserToMoveToNextConcept();
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error in submitMessage:', error);
                    throw error;
                }
            }

            function resetRecordingState() {
                isRecording = false;
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                recordBtn.style.display = 'flex';
                visualizer.style.display = 'none';
                siriOrb.style.boxShadow = "none";
                if (audioContext) {
                    audioContext.close().catch(console.error);
                }
            }

            function displayAudioMessage(audioUrl, sender, transcript) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;

                if (transcript) {
                    const transcriptDiv = document.createElement('div');
                    transcriptDiv.className = 'transcript-text';
                    transcriptDiv.textContent = transcript;
                    messageDiv.appendChild(transcriptDiv);
                }

                const audioContainer = document.createElement('div');
                audioContainer.className = 'audio-container';

                const playButton = document.createElement('div');
                playButton.className = 'play-button';
                playButton.innerHTML = '<i class="fas fa-play"></i>';

                const waveformContainer = document.createElement('div');
                waveformContainer.className = 'waveform-container';

                const waveformVisualization = document.createElement('div');
                waveformVisualization.className = 'waveform-visualization';
                
                for (let i = 0; i < 40; i++) {
                    const waveBar = document.createElement('div');
                    waveBar.className = 'wave-bar';
                    
                    let height;
                    if (i < 5 || i > 35) {
                        height = 20 + Math.random() * 20;
                    } else if ((i > 10 && i < 15) || (i > 25 && i < 30)) {
                        height = 50 + Math.random() * 40;
                    } else {
                        height = 30 + Math.random() * 50;
                    }
                    
                    waveBar.style.height = `${height}%`;
                    waveformVisualization.appendChild(waveBar);
                }
                
                const progressIndicator = document.createElement('div');
                progressIndicator.className = 'progress-indicator';
                
                waveformContainer.appendChild(waveformVisualization);
                waveformContainer.appendChild(progressIndicator);
                
                const durationDisplay = document.createElement('div');
                durationDisplay.className = 'duration-display';
                durationDisplay.textContent = '0:00'; 
                
                const speedToggle = document.createElement('button');
                speedToggle.className = 'speed-toggle';
                speedToggle.textContent = '1x';
                
                const audio = document.createElement('audio');
                audio.className = 'audio-player';
                
                let speedIndex = 0;
                const speeds = [1, 1.5, 2];

                playButton.addEventListener('click', () => {
                    if (audio.paused) {
                        stopAllAudio();
                        audio.play();
                        playButton.innerHTML = '<i class="fas fa-pause"></i>';
                        if (sender === 'ai') {
                            siriOrb.style.boxShadow = "0 0 20px 5px rgba(0, 128, 255, 0.7)";
                        }
                    } else {
                        audio.pause();
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                        if (sender === 'ai') {
                            siriOrb.style.boxShadow = "none";
                        }
                    }
                });

                speedToggle.addEventListener('click', () => {
                    speedIndex = (speedIndex + 1) % speeds.length;
                    const newSpeed = speeds[speedIndex];
                    audio.playbackRate = newSpeed;
                    speedToggle.textContent = newSpeed + 'x';
                });

                // Updated timeupdate event handler for correct countdown
                audio.addEventListener('timeupdate', () => {
                    if (isFinite(audio.duration) && audio.duration > 0) {
                        // Update progress indicator
                        const percent = (audio.currentTime / audio.duration) * 100;
                        progressIndicator.style.left = `${percent}%`;
                        
                        // Calculate time remaining (for countdown)
                        const currentTime = audio.currentTime;
                        const remainingTime = audio.duration - currentTime;
                        const remainingMins = Math.floor(remainingTime / 60);
                        const remainingSecs = Math.floor(remainingTime % 60).toString().padStart(2, '0');
                        
                        durationDisplay.textContent = `${remainingMins}:${remainingSecs}`;
                    }
                });

                waveformContainer.addEventListener('click', (e) => {
                    if (isFinite(audio.duration)) {
                        const rect = waveformContainer.getBoundingClientRect();
                        const clickPosition = (e.clientX - rect.left) / rect.width;
                        audio.currentTime = clickPosition * audio.duration;
                    }
                });

                audio.addEventListener('ended', () => {
                    playButton.innerHTML = '<i class="fas fa-play"></i>';
                    progressIndicator.style.left = '0%';
                    if (sender === 'ai') {
                        siriOrb.style.boxShadow = "none";
                    }
                });

                if (sender === 'user' && audioUrl.startsWith('blob:')) {
                    // Set initial state
                    durationDisplay.textContent = '0:00';
                    
                    // Wait a short time to ensure the blob URL is ready
                    setTimeout(() => {
                        const tempAudio = new Audio();
                        tempAudio.preload = 'metadata';
                        
                        // Set a timeout in case metadata never loads
                        const metadataTimeout = setTimeout(() => {
                            console.log('Metadata loading timeout - falling back to main audio element');
                            // If we time out, rely on the main audio element instead
                        }, 3000);
                        
                        tempAudio.onloadedmetadata = function() {
                            clearTimeout(metadataTimeout);
                            
                            if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                                console.log('Temp audio loaded metadata, duration:', tempAudio.duration);
                                const mins = Math.floor(tempAudio.duration / 60);
                                const secs = Math.floor(tempAudio.duration % 60).toString().padStart(2, '0');
                                durationDisplay.textContent = `${mins}:${secs}`;
                            }
                        };
                        
                        tempAudio.src = audioUrl;
                    }, 100);
                    
                    // Also keep the regular audio element handler as backup
                    audio.addEventListener('loadedmetadata', () => {
                        if (isFinite(audio.duration) && audio.duration > 0 && durationDisplay.textContent === '0:00') {
                            console.log('Main audio loaded metadata, duration:', audio.duration);
                            const totalMins = Math.floor(audio.duration / 60);
                            const totalSecs = Math.floor(audio.duration % 60).toString().padStart(2, '0');
                            durationDisplay.textContent = `${totalMins}:${totalSecs}`;
                        }
                    });
                }
                
                audio.addEventListener('error', (e) => {
                    console.error('Audio loading error:', e);
                    durationDisplay.textContent = '0:00';
                });

                audio.src = audioUrl;
                audio.load(); 

                audioContainer.appendChild(playButton);
                audioContainer.appendChild(waveformContainer);
                audioContainer.appendChild(durationDisplay);
                audioContainer.appendChild(speedToggle);
                audioContainer.appendChild(audio);
                messageDiv.appendChild(audioContainer);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Add additional handling for user recordings to ensure metadata is loaded
                if (sender === 'user' && audioUrl.startsWith('blob:')) {
                    const tempAudio = new Audio();
                    tempAudio.preload = 'metadata';
                    
                    tempAudio.onloadedmetadata = function() {
                        if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                            const mins = Math.floor(tempAudio.duration / 60);
                            const secs = Math.floor(tempAudio.duration % 60).toString().padStart(2, '0');
                            durationDisplay.textContent = `${mins}:${secs}`;
                            
                            if (!isFinite(audio.duration) || audio.duration <= 0) {
                                audio.load();
                            }
                        }
                    };
                    
                    tempAudio.src = audioUrl;
                }
            }
            
            function stopAllAudio() {
                const audios = document.querySelectorAll('audio');
                audios.forEach(audio => {
                    audio.pause();
                    const playButton = audio.parentElement.querySelector('.play-button');
                    if (playButton) {
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                    }
                });
                siriOrb.style.boxShadow = "none";
            }

            function moveToNextSlide() {
                onNextPage();
            }
        });
    </script>
</body>
</html>   -->


















































<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chat with AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #1e293b;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            height: 100%;
            width: 100%;
            position: relative;
            transition: all 0.3s ease;
        }

        .container.chat-open {
            align-items: flex-start;
            padding-left: 0%;
            width: 65%;
            transform: translateX(-10%);
        }

        @media (max-width: 1200px) {
            .container.chat-open {
                transform: translateX(-5%); 
            }
            
            .modal-content {
                margin-bottom: 180px;
            }
        }


        #pdf-container {
             width: 100%;
             height: 100vh;
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 20px 0;
             box-sizing: border-box;
             z-index: 0; 
             transition: all 0.3s ease; 
         }

         #pdf-container.chat-open {
            width: 100%;
            max-width: 65vw;
            justify-content: flex-start;
            margin-left: 5%;
        }
 
        #pdf-canvas {
            width: 75vw;
            height: calc(100vh - 40px);
             max-height: 100%;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }
 
        .page-controls {
             position: fixed; 
             bottom: 20px; 
             display: flex;
             justify-content: center;
             gap: 20px;
             z-index: 100;
             width: 100%; 
             left: 0;
         }
 
        .page-btn {
             background-color: rgba(0, 0, 0, 0.7);
             color: white;
             border: none;
             border-radius: 50%;
             width: 40px;
             height: 40px;
             display: flex;
             justify-content: center;
             align-items: center;
             cursor: pointer;
             transition: background-color 0.3s;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }
 
        .page-btn:hover {
             background-color: rgba(0, 0, 0, 0.9);
         }
 
         .page-counter {
             background-color: rgba(0, 0, 0, 0.7);
             padding: 10px 15px;
             border-radius: 20px;
             display: flex;
             align-items: center;
             box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
         }

        .avatar-container {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 150px;
            height: 150px;
            cursor: pointer;
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .avatar-container:hover {
            transform: scale(1.1);
        }
        
        /* Siri Sphere Animation Styles */
        .siri-orb {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.1) 60%, rgba(255,255,255,0) 70%);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.7;
            mix-blend-mode: screen;
            transform-origin: center;
            transition: all 0.5s ease;
        }
        
        .blob1 {
            width: 75px;
            height: 75px;
            background-color: #00e5ff;
            left: calc(50% - 37.5px);
            top: calc(50% - 50px);
        }
        
        .blob2 {
            width: 80px;
            height: 80px;
            background-color: #ff3366;
            left: calc(50% - 40px);
            top: calc(50% - 20px);
        }
        
        .blob3 {
            width: 70px;
            height: 70px;
            background-color: #7c4dff;
            left: calc(50% - 20px);
            top: calc(50% - 35px);
        }
        
        .wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: transparent;
            border: 2px solid rgba(0, 0, 0, 0.5);
            transform: scale(0);
            opacity: 1;
            pointer-events: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0; 
            width: 35%; 
            height: 98%;
            background-color: transparent;
            justify-content: flex-start;
            align-items: flex-end;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background: #1e293b;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-height: 60vh;
            height: auto;
            margin-right: 20px;
            margin-top: 20px;
            margin-bottom: 170px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slide-in 0.3s ease-out;
            z-index: 999;
            transition: opacity 0.1s ease;
        }

        @keyframes slide-in {
            0% {
                transform: translateX(100px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal-content::after {
            display: none;
        }


        .modal-content:hover, 
        .modal-content.active { 
            opacity: 1;
        }

        .modal-content:not(.active) {
            opacity: 0.1;
        }

        @media (max-width: 768px) {
            .modal-content {
                right: 180px;
                bottom: 80px;
                width: 80%;
            }
        }

        @media (max-width: 576px) {
            .modal-content {
                right: 160px;
                bottom: 60px;
                width: 70%;
            }
        }

        @keyframes pop-up {
            0% {
                transform: scale(0.5) translateY(100px);
                opacity: 0;
            }
            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .modal.show::before {
            opacity: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            height: 20px;
        }

        .modal-header h2 {
            font-family: 'Roboto', sans-serif;
            color: #4fd1c5;
            font-size: 18px;
            font-weight: 600; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            text-align: center;
            padding: 12px 0;
            margin: 0;
            border-bottom: 3px solid #ffffff; 
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #fff;
            background-color: #888;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .close-btn:hover {
            background-color: #e74c3c; 
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
            transform: scale(1.2);
        }

        .close-btn:active {
            background-color: #c0392b; 
            box-shadow: none;
            transform: scale(1);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            background: transparent;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
            max-height: calc(80vh - 150px);            
        }

        @media (max-width: 768px) {
            .modal {
                width: 40%;
            }
            
            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 576px) {
            .modal {
                width: 60%;
            }
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 90%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            position: relative;
            word-wrap: break-word;
            width: fit-content;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .user-message {
            background-color: #4fd1c5;
            color: #1e293b;
            align-self: flex-end;
            border-top-right-radius: 18px;
            border-bottom-right-radius: 5px;
            border: 2px solid #7c4dff;
        }

        .ai-message {
            background-color: #4fd1c5;
            color: #1e293b;
            align-self: flex-start;
            border-top-left-radius: 18px;
            border-bottom-left-radius: 5px;
            border: 2px solid #ff3366;
        }
        
        
        .transcript-text {
            margin-top: 8px;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            width: 100%; 
            box-sizing: border-box;
        }

        .user-message .transcript-text {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .ai-message .transcript-text {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .audio-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box; 
            max-width: 100%;
        }

        .play-button {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            background-color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-button:hover {
            background-color: #38b2ac;
        }

        .play-button:active {
            transform: scale(0.95);
        }

        .waveform {
            width: 100%;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .waveform-container {
            flex-grow: 1;
            height: 40px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin: 0 8px;
            min-width: 150px;
        }
                
        .waveform-visualization {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .wave-bar {
            flex: 1;
            background-color: #1e293b;
            margin: 0 1px;
            border-radius: 1px;
        }

        .progress-indicator {
            position: absolute;
            top: 50%;
            left: 0;
            height: 12px;
            width: 12px;
            background-color: #4fd1c5;
            border-radius: 50%;
            z-index: 3;
            transform: translateY(-50%);
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            transition: left 0.1s linear;
        }

        .progress-container {
            flex-grow: 1;
            position: relative;
            min-width: 150px;
        }

        .progress-bar {
            height: 4px;
            background: #d1d1d1;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            overflow: visible;
        }

        .progress {
            height: 100%;
            background: #4fd1c5;
            border-radius: 2px;
            width: 0%;
            position: relative;
        }

        .progress-thumb {
            width: 12px;
            height: 12px;
            background-color: #4fd1c5;
            border-radius: 50%;
            position: absolute;
            right: -6px;
            top: -4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }

        .duration-display {
            font-size: 12px;
            color: #000000;
            min-width: 40px;
            text-align: center;
        }

        .speed-toggle {
            padding: 4px 8px;
            border-radius: 12px;
            border: none;
            background: #e0e0e0;
            font-size: 12px;
            font-weight: bold;
            color: #444;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .speed-toggle:hover {
            background: #d0d0d0;
        }

        .speed-toggle:active {
            transform: scale(0.95);
        }

        .audio-player {
            display: none; 
        }

        .user-message .progress-bar {
            background: rgba(255, 255, 255, 0.3);
        }

        .user-message .progress {
            background: rgba(255, 255, 255, 0.9);
        }

        .user-message .progress-thumb {
            background: white;
        }

        .user-message .play-button,
        .user-message .speed-toggle {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1e293b;
        }

        .user-message .duration-display {
            color: rgba(255, 255, 255, 0.9);
        }

        .options-menu {
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: opacity 0.3s;
        }

        .options-menu:hover {
            opacity: 0.7;
        }

        .options-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .options-dropdown.show {
            display: block;
        }

        .options-dropdown button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .options-dropdown button:hover {
            background: #f0f0f0;
        }

        .audio-player {
            width: 100%;
            margin-top: 8px;
        }

        .input-bar {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: #2d3748;
            border-radius: 24px;
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        #voice-visualizer {
            display: none;
            flex-grow: 1;
            max-width: 70%;
            height: 40px;
            background-color: transparent;
            border-radius: 8px;
            margin-right: 8px;
        }

        .action-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background-color: #4fd1c5;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-left: auto;
            position: relative; 
            z-index: 5; 
        }

        .action-btn:hover {
            background-color: #38b2ac;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .loading-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-orbit {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .orbit-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: #4fd1c5;
            animation: orbit-spin 1s linear infinite;
        }

        .orbit-circle:nth-child(2) {
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
            border-top-color: #7c4dff;
            animation: orbit-spin 0.8s linear infinite reverse;
        }

        .orbit-circle:nth-child(3) {
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
            border-top-color: #ff3366;
            animation: orbit-spin 0.6s linear infinite;
        }

        @keyframes orbit-spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head> 
<body>
    <div class="container">
        <div id="pdf-container">
            <canvas id="pdf-canvas"></canvas>
            <div id="loading-spinner" class="loading-spinner"></div>
        </div>

        <div class="page-controls">
            <button class="page-btn" id="prev-page"><i class="fas fa-chevron-left"></i></button>
            <div class="page-counter">
                <span id="current-page-num">1</span> / <span id="total-pages">-</span>
            </div>
            <button class="page-btn" id="next-page"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div class="avatar-container" id="chat-avatar">
        <div class="siri-orb">
            <div class="blob blob1"></div>
            <div class="blob blob2"></div>
            <div class="blob blob3"></div>
        </div>
    </div>

    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2></h2>
                    <span class="close-btn" id="close-modal">&times;</span>
            </div>

            <div class="chat-container" id="chat-container"></div>

            <div class="input-bar">
                <canvas id="voice-visualizer"></canvas>
                <button class="action-btn" id="record-btn">
                    <i class="fas fa-microphone"></i>                    </button>
            </div>
            
            <div class="loading-indicator" id="loading-indicator">
                <div class="loading-orbit">
                    <div class="orbit-circle"></div>
                    <div class="orbit-circle"></div>
                    <div class="orbit-circle"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const url = '/resources/Univariate Analysis.pdf';
    const avatar = document.getElementById('chat-avatar');
    const modal = document.getElementById('chat-modal');
    const closeModal = document.getElementById('close-modal');
    const recordBtn = document.getElementById('record-btn');
    const chatContainer = document.getElementById('chat-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const visualizer = document.getElementById('voice-visualizer');
    const siriOrb = document.querySelector('.siri-orb');
    const blobs = document.querySelectorAll('.blob');
    const userMessages = document.querySelectorAll('.user-message');
    const lastUserMessage = userMessages[userMessages.length - 1];
    if (lastUserMessage) {
        const transcriptDiv = lastUserMessage.querySelector('.transcript-text');
        if (transcriptDiv) {
            transcriptDiv.textContent = data.user_transcript;
        }
    }

    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let isAnimating = false;
    let waves = [];
    let waveCount = 0;
    let currentConcept = "Default";
    let introPlayed = false; 
    let pdfDoc = null,
    pageNum = 1,
    pageRendering = false,
    pageNumPending = null,
    scale = 1.5,
    visualizerCanvas = document.getElementById('pdf-canvas'),
    visualizerCtx = visualizerCanvas.getContext('2d');

    window.audioContext = null;
    try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.audioContext = new AudioContext();
    } catch (e) {
        console.error('Web Audio API is not supported in this browser', e);
    }

    function renderPage(num) {
        pageRendering = true;

        pdfDoc.getPage(num).then(function(page) {
            const pdfContainer = document.getElementById('pdf-container');
            const containerWidth = pdfContainer.clientWidth;
            const containerHeight = pdfContainer.clientHeight;
            
            const viewport = page.getViewport({ scale: 1.0 });
            const scaleWidth = containerWidth / viewport.width * 0.85; // Slightly smaller to avoid edges
            const scaleHeight = containerHeight / viewport.height * 0.85;
            const optimalScale = Math.min(scaleWidth, scaleHeight);
            
            const scaledViewport = page.getViewport({ scale: optimalScale });
            
            canvas.height = scaledViewport.height;
            canvas.width = scaledViewport.width;

            const scaleFactor = window.devicePixelRatio || 1;
            visualizerCanvas.width = scaledViewport.width * scaleFactor;
            visualizerCanvas.height = scaledViewport.height * scaleFactor;

            visualizerCtx.setTransform(scaleFactor, 0, 0, scaleFactor, 0, 0);

            const renderContext = {
                canvasContext: visualizerCtx,
                viewport: scaledViewport
            };
            
            const renderTask = page.render(renderContext);

            renderTask.promise.then(function() {
                pageRendering = false;

                if (pageNumPending !== null) {
                    renderPage(pageNumPending);
                    pageNumPending = null;
                }
            });

            updateModalTitle(num);
            
            const newConcept = getConceptNameForSlide(num);
            if (currentConcept !== newConcept) {
                currentConcept = newConcept;
                notifyConceptChange(currentConcept);
            }
        });

        document.getElementById('current-page-num').textContent = num;
    }

    window.addEventListener('resize', () => {
        if (pdfDoc) {
            queueRenderPage(pageNum);
        }
    });

    function updateModalTitle(pageNumber) {
        const chatModalHeader = document.querySelector('.modal-header h2');
        const concept = getConceptNameForSlide(pageNumber) || "Have Fun!!"; 
        chatModalHeader.textContent = concept;
    }

    function queueRenderPage(num) {
        if (pageRendering) {
            pageNumPending = num;
        } else {
            renderPage(num);
        }
    }

    function onPrevPage() {
        if (pageNum <= 1) return;
        pageNum--;
        queueRenderPage(pageNum);
    }

    function onNextPage() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        queueRenderPage(pageNum);
    }

    function notifyConceptChange(conceptName) {
        fetch('/change_concept', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                concept_name: conceptName
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Concept change notification sent:', data);
        })
        .catch(error => {
            console.error('Error notifying concept change:', error);
        });
    }
    
    function notifyUserToMoveToNextConcept() {
        const notification = document.createElement('div');
        notification.className = 'next-concept-notification';
        notification.innerHTML = `
            <p>You've completed this concept. Please move to the next concept.</p>
            <button id="next-concept-btn">Go to Next Concept</button>
        `;
        
        document.body.appendChild(notification);
        
        document.getElementById('next-concept-btn').addEventListener('click', function() {
            onNextPage();
            notification.remove();
        });
    }

    function getConceptNameForSlide(slideNumber) {
        const conceptMap = {
            1: "Univariate Analysis",
            2: "Univariate Analysis",
            3: "Measures of Central Tendency",
            4: "Measures of Dispersion"
        };
        
        return conceptMap[slideNumber] || "Unknown Concept";
    }

    document.getElementById('prev-page').addEventListener('click', onPrevPage);
    document.getElementById('next-page').addEventListener('click', onNextPage);

    document.querySelectorAll('.slide-nav-button').forEach(button => {
        button.addEventListener('click', function() {
            const targetSlide = this.getAttribute('data-target-slide');
            if (targetSlide) {
                const slideNum = parseInt(targetSlide, 10);
                if (!isNaN(slideNum)) {
                    pageNum = slideNum;
                    queueRenderPage(pageNum);
                    
                    const conceptName = getConceptNameForSlide(slideNum);
                    notifyConceptChange(conceptName);
                }
            }
        });
    });

    pdfjsLib.getDocument(url).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        document.getElementById('total-pages').textContent = pdfDoc.numPages;
        renderPage(pageNum);
    }).catch(err => {
        console.error('Error loading PDF:', err);
        alert('Failed to load PDF: ' + err.message);
    });

    const canvas = document.getElementById('voice-visualizer');
    canvas.width = 500;
    canvas.height = 40;
    const canvasCtx = canvas.getContext('2d');
    let audioContext, analyser, dataArray, animationId;

    const introAudioUrl = '/uploads/ai_audio/intro_message.mp3';

    // Siri Animation Functions
    function animateBlobs() {
        blobs.forEach((blob, index) => {
            const speed = 2 + index * 0.5;
            const time = performance.now() / 1000;
            const x = Math.sin(time * speed) * 10;
            const y = Math.cos(time * (speed + 0.5)) * 10;
            
            blob.style.transform = `translate(${x}px, ${y}px) scale(${0.8 + Math.sin(time * speed) * 0.1})`;
        });
        
        requestAnimationFrame(animateBlobs);
    }
    
    function createWave() {
        const wave = document.createElement('div');
        wave.className = 'wave';
        wave.id = `wave-${waveCount++}`;
        avatar.appendChild(wave);
        waves.push(wave);
        
        setTimeout(() => {
            wave.style.transition = 'all 2s cubic-bezier(0.1, 0.8, 0.1, 1)';
            wave.style.transform = 'scale(1.5)';
            wave.style.opacity = '0';
        }, 10);
        
        setTimeout(() => {
            avatar.removeChild(wave);
            waves = waves.filter(w => w !== wave);
        }, 2000);
    }
    
    function activateSiriOrb() {
        if (isAnimating) return;
        isAnimating = true;
        
        createWave();
        setTimeout(createWave, 200);
        setTimeout(createWave, 400);
        
        siriOrb.style.transform = 'scale(1.1)';
        setTimeout(() => {
            siriOrb.style.transform = 'scale(1)';
        }, 300);
        
        blobs.forEach((blob, index) => {
            const delay = index * 100;
            setTimeout(() => {
                blob.style.transform = 'scale(1.2) translate(0, 0)';
                setTimeout(() => {
                    blob.style.transform = 'scale(1) translate(0, 0)';
                }, 400);
            }, delay);
        });
        
        setTimeout(() => {
            isAnimating = false;
        }, 800);
    }
    
    animateBlobs();

    function getCurrentConcept() {
        return getConceptNameForSlide(pageNum);
    }

    const modalContent = document.querySelector('.modal-content');

    function showModal() {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        
        document.querySelector('.container').classList.add('chat-open');
        document.getElementById('pdf-container').classList.add('chat-open');
        
        if (pdfDoc) {
            setTimeout(() => {
                queueRenderPage(pageNum);
            }, 300);
        }

        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        if (!introPlayed) {
            fetch('/get_intro_audio')
                .then(response => response.json())
                .then(data => {
                    if (data.intro_audio_url) {
                        displayAudioMessage(data.intro_audio_url, 'ai', data.intro_text || "Welcome! I'm your AI assistant for this Univariate Analysis session.");
                        introPlayed = true;
                    } else {
                        console.error('Error getting intro audio:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching intro audio:', error);
                });
        }
        
        activateSiriOrb();
        
        currentConcept = getCurrentConcept();
        console.log("Current concept set to:", currentConcept);
        
        notifyConceptChange(currentConcept);
        
        modalContent.classList.add('active');
    }

    function hideModal() {
        modal.classList.remove('show');
        
        document.querySelector('.container').classList.remove('chat-open');
        document.getElementById('pdf-container').classList.remove('chat-open');
        
        if (pdfDoc) {
            setTimeout(() => {
                queueRenderPage(pageNum);
            }, 300);
        }

        setTimeout(() => {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }, 300); 
        
        stopAllAudio();
        if (animationId) {
            cancelAnimationFrame(animationId);
        }
    }

    avatar.addEventListener('click', () => {
        if (modal.classList.contains('show')) {
            hideModal();
        } else {
            showModal();
        }
    });


    closeModal.addEventListener('click', hideModal);

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            hideModal();
        }
    });

    recordBtn.addEventListener('click', async () => {
        if (!isRecording) {
            try {
                audioChunks = [];
                isRecording = true;
                recordBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                activateSiriOrb();
                siriOrb.style.boxShadow = "0 0 20px 5px rgba(255, 255, 255, 0.7)";
                
                visualizer.style.display = 'block';
                recordBtn.style.display = 'flex';

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                if (!window.audioContext) {
                    window.audioContext = new AudioContext();
                }
                
                audioContext = window.audioContext;
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);

                source.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm'});
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event);
                    alert('Error recording audio: ' + event.error);
                    resetRecordingState();
                };
                
                mediaRecorder.start();
                console.log("MediaRecorder started", mediaRecorder.state);

                visualize();
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Unable to access microphone. Please check permissions.');
                resetRecordingState();
            }
        } else {
            recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';

            stopRecording();
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            recordBtn.style.display = 'flex';
            visualizer.style.display = 'none';
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            siriOrb.style.boxShadow = "none";
            
        }
    });

    function visualize() {
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        const BAR_WIDTH = 3;
        const GAP = 2;
        const NUM_BARS = Math.floor(WIDTH / (BAR_WIDTH + GAP));

        function draw() {
            animationId = requestAnimationFrame(draw);

            analyser.getByteFrequencyData(dataArray);

            canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

            for (let i = 0; i < NUM_BARS; i++) {
                const value = dataArray[i % dataArray.length] || 0;
                const barHeight = (value / 255) * HEIGHT;
                
                const x = i * (BAR_WIDTH + GAP);
                const y = HEIGHT - barHeight;

                const hue = 180 - (value / 255) * 60;
                const color = `hsl(${hue}, 80%, 60%)`;

                canvasCtx.fillStyle = color;
                canvasCtx.fillRect(x, y, BAR_WIDTH, barHeight);
            }
        }

        draw();
    }

    function stopRecording() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            console.warn('MediaRecorder not active');
            return;
        }
        
        console.log("Stopping MediaRecorder", mediaRecorder.state);
        isRecording = false;
        
        try {
            mediaRecorder.stop();
        } catch (err) {
            console.error('Error stopping MediaRecorder:', err);
            resetRecordingState();
            return;
        }

        mediaRecorder.onstop = async () => {
            try {
                loadingIndicator.classList.add('active');
                
                if (audioChunks.length === 0) {
                    throw new Error('No audio data recorded');
                }
                
                currentConcept = getCurrentConcept();
                console.log("Sending audio for concept:", currentConcept);
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                await submitMessage(null, audioBlob);
                
            } catch (error) {
                console.error('Error processing audio:', error);
                alert('Error processing audio: ' + error.message);
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            } finally {
                loadingIndicator.classList.remove('active');
            }
        };
    }

    async function submitMessage(message = null, audioBlob = null) {
        try {
            const formData = new FormData();
            
            const currentConcept = getCurrentConcept();
            
            if (message) {
                formData.append('message', message);
            }
            
            if (audioBlob) {
                formData.append('audio', audioBlob, 'user_audio.wav');
                const userAudioUrl = URL.createObjectURL(audioBlob);
                displayAudioMessage(userAudioUrl, 'user', 'Your message is being processed...');
            }
            
            formData.append('concept_name', currentConcept);
            
            console.log("Sending data to server with concept:", currentConcept);
            
            const response = await fetch('/submit_message', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log("Server response:", data);

            if (data.error) {
                throw new Error(data.error);
            }

            const userMessages = document.querySelectorAll('.user-message');
            const lastUserMessage = userMessages[userMessages.length - 1];
            if (lastUserMessage) {
                const transcriptDiv = lastUserMessage.querySelector('.transcript-text');
                if (transcriptDiv) {
                    transcriptDiv.textContent = data.user_transcript || message;
                }
            }

            displayAudioMessage(data.ai_audio_url, 'ai', data.response || data.ai_transcript);
            activateSiriOrb();
            
            if (data.should_move_to_next) {
                notifyUserToMoveToNextConcept();
            }
            
            return data;
        } catch (error) {
            console.error('Error in submitMessage:', error);
            throw error;
        }
    }

    function resetRecordingState() {
        isRecording = false;
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        recordBtn.style.display = 'flex';
        visualizer.style.display = 'none';
        siriOrb.style.boxShadow = "none";
        if (audioContext && audioContext !== window.audioContext) {
            audioContext.close().catch(console.error);
        }
    }

    function displayAudioMessage(audioUrl, sender, transcript) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}-message`;

        if (transcript) {
            const transcriptDiv = document.createElement('div');
            transcriptDiv.className = 'transcript-text';
            transcriptDiv.textContent = transcript;
            messageDiv.appendChild(transcriptDiv);
        }

        const audioContainer = document.createElement('div');
        audioContainer.className = 'audio-container';

        const playButton = document.createElement('div');
        playButton.className = 'play-button';
        playButton.innerHTML = '<i class="fas fa-play"></i>';

        const waveformContainer = document.createElement('div');
        waveformContainer.className = 'waveform-container';

        const waveformVisualization = document.createElement('div');
        waveformVisualization.className = 'waveform-visualization';
        
        for (let i = 0; i < 40; i++) {
            const waveBar = document.createElement('div');
            waveBar.className = 'wave-bar';
            
            let height;
            if (i < 5 || i > 35) {
                height = 20 + Math.random() * 20;
            } else if ((i > 10 && i < 15) || (i > 25 && i < 30)) {
                height = 50 + Math.random() * 40;
            } else {
                height = 30 + Math.random() * 50;
            }
            
            waveBar.style.height = `${height}%`;
            waveformVisualization.appendChild(waveBar);
        }
        
        const progressIndicator = document.createElement('div');
        progressIndicator.className = 'progress-indicator';
        
        waveformContainer.appendChild(waveformVisualization);
        waveformContainer.appendChild(progressIndicator);
        
        const durationDisplay = document.createElement('div');
        durationDisplay.className = 'duration-display';
        durationDisplay.textContent = 'Loading...'; 
        
        const speedToggle = document.createElement('button');
        speedToggle.className = 'speed-toggle';
        speedToggle.textContent = '1x';
        
        const audio = document.createElement('audio');
        audio.className = 'audio-player';
        
        let speedIndex = 0;
        const speeds = [1, 1.5, 2];
        
        audio.addEventListener('loadedmetadata', () => {
            if (isFinite(audio.duration) && audio.duration > 0) {
                const totalMins = Math.floor(audio.duration / 60);
                const totalSecs = Math.floor(audio.duration % 60).toString().padStart(2, '0');
                durationDisplay.textContent = `${totalMins}:${totalSecs}`;
                console.log(`Audio metadata loaded. Duration: ${audio.duration}s`);
            }
        });
        
        audio.addEventListener('error', (e) => {
            console.error('Audio loading error:', e);
            durationDisplay.textContent = 'Error';
        });

        audio.preload = 'metadata';
        audio.src = audioUrl;
        audio.load();

        playButton.addEventListener('click', () => {
            if (audio.paused) {
                stopAllAudio();
                audio.play();
                playButton.innerHTML = '<i class="fas fa-pause"></i>';
                if (sender === 'ai') {
                    siriOrb.style.boxShadow = "0 0 20px 5px rgba(0, 128, 255, 0.7)";
                }
            } else {
                audio.pause();
                playButton.innerHTML = '<i class="fas fa-play"></i>';
                if (sender === 'ai') {
                    siriOrb.style.boxShadow = "none";
                }
            }
        });

        speedToggle.addEventListener('click', () => {
            speedIndex = (speedIndex + 1) % speeds.length;
            const newSpeed = speeds[speedIndex];
            audio.playbackRate = newSpeed;
            speedToggle.textContent = newSpeed + 'x';
        });

        audio.addEventListener('timeupdate', () => {
            if (isFinite(audio.duration) && audio.duration > 0) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressIndicator.style.left = `${percent}%`;
                
                const remainingTime = audio.duration - audio.currentTime;
                const remainingMins = Math.floor(remainingTime / 60);
                const remainingSecs = Math.floor(remainingTime % 60).toString().padStart(2, '0');
                
                durationDisplay.textContent = `${remainingMins}:${remainingSecs}`;
            }
        });

        waveformContainer.addEventListener('click', (e) => {
            if (isFinite(audio.duration)) {
                const rect = waveformContainer.getBoundingClientRect();
                const clickPosition = (e.clientX - rect.left) / rect.width;
                audio.currentTime = clickPosition * audio.duration;
            }
        });

        audio.addEventListener('ended', () => {
            playButton.innerHTML = '<i class="fas fa-play"></i>';
            progressIndicator.style.left = '0%';
            if (sender === 'ai') {
                siriOrb.style.boxShadow = "none";
            }
        });

        audioContainer.appendChild(playButton);
        audioContainer.appendChild(waveformContainer);
        audioContainer.appendChild(durationDisplay);
        audioContainer.appendChild(speedToggle);
        audioContainer.appendChild(audio);
        messageDiv.appendChild(audioContainer);
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        if (sender === 'user' && audioUrl.startsWith('blob:')) {
            console.log("Processing blob URL for user audio:", audioUrl);
            
            const metadataTimeout = setTimeout(() => {
                if (durationDisplay.textContent === 'Loading...') {
                    durationDisplay.textContent = '0:--'; // Use a placeholder
                    console.log('Using placeholder duration - metadata loading timeout');
                }
            }, 1000);
            
            if (window.audioContext) {
                fetch(audioUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const fileReader = new FileReader();
                        fileReader.onload = function() {
                            const arrayBuffer = this.result;
                            
                            window.audioContext.decodeAudioData(arrayBuffer)
                                .then(decodedData => {
                                    clearTimeout(metadataTimeout);
                                    const duration = decodedData.duration;
                                    const mins = Math.floor(duration / 60);
                                    const secs = Math.floor(duration % 60).toString().padStart(2, '0');
                                    durationDisplay.textContent = `${mins}:${secs}`;
                                    console.log(`Decoded audio duration: ${duration}s`);
                                    
                                    if (!isFinite(audio.duration) || audio.duration <= 0) {
                                        audio.load();
                                    }
                                })
                                .catch(err => {
                                    console.error('Error decoding audio data:', err);
                                    
                                    estimateDurationFromBlob(blob, durationDisplay, metadataTimeout);
                                });
                        };
                        
                        fileReader.readAsArrayBuffer(blob);
                    })
                    .catch(err => {
                        console.error('Error fetching blob for decoding:', err);
                        
                        const tempAudio = new Audio();
                        
                        tempAudio.addEventListener('loadedmetadata', () => {
                            clearTimeout(metadataTimeout);
                            if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                                const mins = Math.floor(tempAudio.duration / 60);
                                const secs = Math.floor(tempAudio.duration % 60).toString().padStart(2, '0');
                                durationDisplay.textContent = `${mins}:${secs}`;
                                console.log(`Temp audio metadata loaded. Duration: ${tempAudio.duration}s`);
                            }
                        });
                        
                        tempAudio.src = audioUrl;
                        tempAudio.load();
                    });
            } else {
                const tempAudio = new Audio();
                
                tempAudio.addEventListener('loadedmetadata', () => {
                    clearTimeout(metadataTimeout);
                    if (isFinite(tempAudio.duration) && tempAudio.duration > 0) {
                        const mins = Math.floor(tempAudio.duration / 60);
                        const secs = Math.floor(tempAudio.duration % 60).toString().padStart(2, '0');
                        durationDisplay.textContent = `${mins}:${secs}`;
                        console.log(`Temp audio metadata loaded. Duration: ${tempAudio.duration}s`);
                    }
                });
                
                fetch(audioUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        estimateDurationFromBlob(blob, durationDisplay, metadataTimeout);
                    })
                    .catch(err => console.error('Error fetching blob:', err));
                
                tempAudio.src = audioUrl;
                tempAudio.load();
            }
        }
        
        return messageDiv;
    }
    
    function estimateDurationFromBlob(blob, durationDisplay, timeoutToCancel) {
        if (blob.size > 0) {
            const estimatedSecs = Math.max(1, blob.size / 16000); 
            const mins = Math.floor(estimatedSecs / 60);
            const secs = Math.floor(estimatedSecs % 60).toString().padStart(2, '0');
            
            if (durationDisplay.textContent === 'Loading...' || 
                durationDisplay.textContent === '0:00' || 
                durationDisplay.textContent === '0:--') {
                durationDisplay.textContent = `${mins}:${secs}`;
                durationDisplay.textContent = `${mins}:${secs}`;
                console.log(`Estimated duration from blob size (${blob.size} bytes): ${mins}:${secs}`);
                
                if (timeoutToCancel) {
                    clearTimeout(timeoutToCancel);
                }
            }
        }
    }

            function stopAllAudio() {
                const audios = document.querySelectorAll('audio');
                audios.forEach(audio => {
                    audio.pause();
                    const playButton = audio.parentElement.querySelector('.play-button');
                    if (playButton) {
                        playButton.innerHTML = '<i class="fas fa-play"></i>';
                    }
                });
                siriOrb.style.boxShadow = "none";
            }

            function moveToNextSlide() {
                onNextPage();
            }
        });
    </script>
</body>
</html>  